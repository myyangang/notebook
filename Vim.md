# Vim

参考资料：

- [《Vim实用技巧》]()

# §2 实用技巧

## §2.1 `.`命令

`.`命令用于重复执行上一次的操作。从本质上来说，该命令是一种宏。所以对于高频次的重复操作，问题就转化为如何将这种操作设计成`.`命令可以重复的方式。

学完这一节后，我们就会知道：`.`只负责修改，还需要另一个命令进行移动。移动和修改交替进行，这种方法称为`.`范式。

### §2.1.1 空格格式化

给定以下任务，要求字符串之间的加号两侧带有空格：

```
"123"+"456"+"789"
"123" + "456" + "789"
```

操作步骤如下：

1. 将光标移动到行首，使用`f+`找到本行的第一个加号。
2. 使用`s`删除光标所在的字符，即第一个加号。
3. 输入`<空格>+<空格>`为第一个加号的两侧补充空格，按`<Esc>`退出。
4. 使用`;`表示向右查找后面的加号，再使用`.`命令重复第2、3步操作。
5. 重复第4步操作。

### §2.1.2 选择性替换

使用`%s/<原字符串>/<新字符串>/g`进行全局替换时，我们无法决定单个匹配项是否应该替换。

```
like appoint play
dislike disappoint play
```

下面介绍一种方法：

1. 将光标移动到要替换的单词内部。
2. 按下`*`，匹配到当前单词下一次出现的第一个字符。
3. 使用`cw`更改当前单词，输入`<新字符串>`完成单处替换。
4. 按下`n`，来延续`*`查找操作在寄存器中的内容，移动到下一次出现的第一个字符。
5. 重复步骤3、4，如果不想替换的话只重复步骤4。

## §2.2 复合命令

Vim将很多常用的两步操作合并成了一步，而这一步操作通常都是插入命令。

| 复合命令 | 复合命令的作用                 | 等效的长命令 | 等效的长命令作用                                   |
| -------- | ------------------------------ | ------------ | -------------------------------------------------- |
| `A`      | 在一行的结尾添加内容           | `$a`         | 将光标移动到最后一行，然后在光标的后面进入插入模式 |
| `s`      | 删除光标下的字符并进入编辑模式 | `cl`         | 更改光标右侧的字符                                 |
| `S`      |                                | `^c`         | ？？？？？？？                                     |
| `I`      |                                | `^i`         |                                                    |
| `A`      |                                | `$a`         |                                                    |
| `o`      |                                | `A<回车>`    |                                                    |
| `O`      |                                | `ko`         |                                                    |

## §2.3 重复与撤销

Vim为许多命令提过了对应的重复命令和撤销命令。

| 操作                       | 作用                           | 重复命令 | 撤销命令 |
| -------------------------- | ------------------------------ | -------- | -------- |
| 一次修改                   | `{编辑}`                       | `.`      | `u`      |
| 在行内搜索下一个字符位置   | `f{字符}`/`t{字符}`            | `;`      | `,`      |
| 在行内搜索上一个字符位置   | `F{字符}`/`T{字符}`            | `;`      | `,`      |
| 在文档中搜索下一处匹配位置 | `/<字符串><回车>`              | `n`      | `N`      |
| 在文档中搜索上一处匹配位置 | `?<字符串><回车>`              | `n`      | `N`      |
| 一次替换                   | `:s/<原字符串>/<替换后字符串>` | `n`      | `u`      |
| 多次修改                   | `qx{编辑}q`                    | `@x`     | `u`      |

### §2.3.1 撤销粒度

我们知道`u`命令用于撤销最近的一次修改。从按下`i`进入编辑模式开始，到按下`<ESC>`退出编辑模式位置，中间进行的所有修改记为一次修改。于是，我们可以通过控制每次编辑的内容，来控制撤销命令作用的范围，我们称之为撤销粒度。

> 注意：在插入模式中，使用箭头键会导致原先的撤销粒度被清空。为了便于理解，我们可以将其理解为先用`<ESC>`退出编辑模式，然后用``j`/`k`/`l``/`'`方位键进行移动，再按下`i`进入编辑模式。

### §2.3.2 构造可重复操作

给定以下文本，现在光标停留在单词`is`的最后一个字符。要求只保留两端的单词，删除中间的所有单词。

```
this is my favorite editor
this vim
```

下面我们要介绍三种操作，它们的操作步数均为3，但是可重复性有所不同。

1. 反向删除
   1. 使用`db`命令，删除从光标左侧开始，到单词开头的所有字符，此时字符`i`被删除，但是字符`s`没有被删除。
   2. 使用`x`命令，删除当前光标下的字符。
2. 正向删除
   1. 使用`b`命令，将光标移动到单词`is`的开头。
   2. 使用`dw`命令，删除从光标位置起、到光标位置所在的单词后的空格之间的所有字符（包括两端）。
3. 删除整个单词
   - 使用`daw`命令，删除光标所在的单词或空格之后的单词（包括空格）。

使用`.`命令重复上述操作时，第一种方法“反向删除”会删除当前光标下的字符，也就是空格；第二种方法“正向删除”会删除光标所在的单词，但是此时光标指向空格，所以删除的是空格；第三种该方法才能连续地删除单词。

### §2.3.3 指定重复次数

Vim的大多数命令支持在前面添加执行次数。例如`<Ctrl-x>`命令会尝试从光标开始向后搜寻最近的一个数字，并且将其减$1$。于是使用`100<Ctrl-a>`命令可以加$100$。

> 注意：如果数字字符串的开头有前导$0$，那么Vim会将其视为八进制数字，在字符串长度不变的前提下对其运算。如果需要让Vim默认所有数字均为十进制，可以编辑`.vimrc`文件。
>
> ```vimrc
> set nrformats=
> ```

要连续地删除两个单词，我们可以使用`d2w`命令或`2dw`命令。两者的作用完全相同，但是语义有所区别。`d2w`表示一次性删除两个单词；`2dw`命令表示重复两次删除一个单词的动作。同理，要连续地恢复两次操作，我们可以用`2.`命令；要一次性修改三个单词，我们可以使用`c3w`命令。

## §2.4 命令语法

Vim的操作由两部分构成：操作符与动作命令。以`daw`为例，`d`是操作符，表示删除，而后面的`aw`是动作命令，表示一个单词。

这种语法的优点在于其扩展能力强。例如我们已经知道`daw`用于删除一个单词，`gUap`表示将一个自然段中的所有字母全转为大写，那么很容易猜出来：`dap`表示删除一个自然段。

除此以外，Vim只有一个额外的语法：连续使用两次操作符，则动作命令默认指向当前行。例如`dd`表示删除当前行，`>>`表示缩进当前行。后来在此基础上，Vim语法对于以`g`开头进行转义的命令进行进一步简化。以`gU`为例，我们既可以使用`gUgU`，也可以使用`gUU`。

下表列出了Vim的所有操作符：

| 命令 | 用途                                   |
| ---- | -------------------------------------- |
| `c`  | 修改(change)                           |
| `d`  | 删除                                   |
| `y`  | 复制到寄存器                           |
| `g-` | 大小写反转                             |
| `gu` | 转换为小写                             |
| `gU` | 转换为大写                             |
| `>`  | 增加缩进                               |
| `<`  | 减小缩进                               |
| `=`  | 自动缩进                               |
| `!`  | 使用外部程序过滤`<动作命令>`所跨越的行 |

### §2.4.1 自定义操作符

Vim标准中的操作符数量较少，但是允许用户自定义新的操作符。以Tim Pope开发的[`commentary.vim`插件](https://github.com/tpope/vim-commentary)为例，它自定义了`\\`操作符用于切换注释。例如`\\ap`表示对当前自然段切换注释。

### §2.4.2 自定义动作命令

Vim标准中的动作命令已经很全面了，但是仍然允许用户自定义新的动作命令。以Kana Natsuno开发的[`textobj-entire`插件](https://github.com/kana/vim-textobj-entire)为例，它添加了两种针对整个文件的新文本对象——`ie`和`ae`。

在安装插件之前，如果要缩进整个文件，我们需要先用`gg`将光标移动到文件开头，然后再用`=G`表示对从光标到文件末尾的所有内容（即整个文档）执行自动缩进。而安装插件后，我们执行`=ae`命令即可。

## §2.5 插入模式

插入模式也有快捷键可用。这些快捷键以可以在`Bash`等Shell中使用。

| 插入模式快捷键 | 作用                                       |
| -------------- | ------------------------------------------ |
| `<Ctrl+h>`     | 删除前一个字符（等价于退格键）             |
| `<Ctrl+w>`     | 删除至前一个单词                           |
| `<Ctrl+u>`     | 删除至行首                                 |
| `<Ctrl+[>`     | 切换至普通模式（等价于`<Esc>`）            |
| `<Ctrl+o>`     | 切换至普通模式，执行一个命令后返回插入模式 |

### §2.5.1 插入-普通模式

在插入模式下使用`<Ctrl+o>`，会进入插入-普通模式，具体行为是切换至普通模式，执行一个命令后返回插入模式。

例如使用`<Ctrl+o>zz`，让光标所在行位于Shell水平居中处。